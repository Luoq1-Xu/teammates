<tm-loading-retry [shouldShowRetry]="hasLoadingFailed" [message]="'Failed to load question analytics'" (retryEvent)="loadResponses()">
  <div *tmIsLoading="isLoading">
    <div *ngIf="questionResult">
      <!-- TEXT Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.TEXT">
        <h5>Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 25px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Status</h6>
                <div class="row text-center">
                  <div class="col-6">
                    <div class="text-success">
                      <strong>{{ respondedCount }}</strong>
                      <br>
                      <small>Responded</small>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-muted">
                      <strong>{{ responses.length - respondedCount }}</strong>
                      <br>
                      <small>No Response</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MCQ Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.MCQ">
        <h5>MCQ Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Choice Distribution</h6>
                <div *ngFor="let choice of mcqChoices" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ choice }}</span>
                    <span class="badge bg-primary">{{ mcqAnswerFrequency[choice] }} ({{ mcqPercentagePerOption[choice] }}%)</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-info"
                         [style.width.%]="mcqPercentagePerOption[choice]"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="mcqChoices.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MSQ Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.MSQ">
        <h5>MSQ Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Selection Statistics</h6>
                <div class="row text-center">
                  <div class="col-12 mb-2">
                    <div class="text-info">
                      <strong>{{ msqTotalSelections }}</strong>
                      <br>
                      <small>Total Selections</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-primary">
                      <strong>{{ msqAverageSelectionsPerResponse }}</strong>
                      <br>
                      <small>Avg per Response</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Choice Distribution</h6>
                <div *ngFor="let choice of msqChoices" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ choice }}</span>
                    <span class="badge bg-primary">{{ msqAnswerFrequency[choice] }} ({{ msqPercentagePerOption[choice] }}%)</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-warning"
                         [style.width.%]="msqPercentagePerOption[choice]"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="msqChoices.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NUMSCALE Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.NUMSCALE">
        <h5>Numerical Scale Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Statistical Summary</h6>
                <div class="row text-center">
                  <div class="col-6 mb-2">
                    <div class="text-primary">
                      <strong>{{ numscaleAverage }}</strong>
                      <br>
                      <small>Average</small>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="text-info">
                      <strong>{{ numscaleMedian }}</strong>
                      <br>
                      <small>Median</small>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="text-success">
                      <strong>{{ numscaleStdDev }}</strong>
                      <br>
                      <small>Std Dev</small>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-secondary">
                      <strong>{{ numscaleMin }} - {{ numscaleMax }}</strong>
                      <br>
                      <small>Range</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Value Distribution</h6>
                <div *ngFor="let value of numscaleDistribution | keyvalue: originalOrder" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ value.key }}</span>
                    <span class="badge bg-success">{{ value.value }} responses</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-success"
                         [style.width.%]="(value.value / respondedCount) * 100"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="respondedCount === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSTSUM Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.CONSTSUM">
        <h5>Constant Sum Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Point Distribution</h6>
                <div class="row text-center">
                  <div class="col-12 mb-2">
                    <div class="text-info">
                      <strong>{{ constsumTotalPointsDistributed }}</strong>
                      <br>
                      <small>Total Points</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-primary">
                      <strong>{{ constsumAveragePointsPerResponse }}</strong>
                      <br>
                      <small>Avg per Response</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Average Points per Option</h6>
                <div *ngFor="let option of constsumOptions" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ option }}</span>
                    <span class="badge bg-info">{{ constsumAveragePerOption[option] }} avg points</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-info"
                         [style.width.%]="constsumAveragePointsPerResponse > 0 ? (constsumAveragePerOption[option] / constsumAveragePointsPerResponse) * 100 : 0"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="constsumOptions.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSTSUM_OPTIONS Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.CONSTSUM_OPTIONS">
        <h5>Constant Sum (Options) Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Point Distribution</h6>
                <div class="row text-center">
                  <div class="col-12 mb-2">
                    <div class="text-info">
                      <strong>{{ constsumTotalPointsDistributed }}</strong>
                      <br>
                      <small>Total Points</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-primary">
                      <strong>{{ constsumAveragePointsPerResponse }}</strong>
                      <br>
                      <small>Avg per Response</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Average Points per Option</h6>
                <div *ngFor="let option of constsumOptions" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ option }}</span>
                    <span class="badge bg-secondary">{{ constsumAveragePerOption[option] }} avg points</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-secondary"
                         [style.width.%]="constsumAveragePointsPerResponse > 0 ? (constsumAveragePerOption[option] / constsumAveragePointsPerResponse) * 100 : 0"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="constsumOptions.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSTSUM_RECIPIENTS Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.CONSTSUM_RECIPIENTS">
        <h5>Constant Sum (Recipients) Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Point Distribution</h6>
                <div class="row text-center">
                  <div class="col-12 mb-2">
                    <div class="text-info">
                      <strong>{{ constsumTotalPointsDistributed }}</strong>
                      <br>
                      <small>Total Points</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-primary">
                      <strong>{{ constsumAveragePointsPerResponse }}</strong>
                      <br>
                      <small>Avg per Response</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Average Points per Recipient</h6>
                <div *ngFor="let option of constsumOptions" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ option }}</span>
                    <span class="badge bg-dark">{{ constsumAveragePerOption[option] }} avg points</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-dark"
                         [style.width.%]="constsumAveragePointsPerResponse > 0 ? (constsumAveragePerOption[option] / constsumAveragePointsPerResponse) * 100 : 0"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="constsumOptions.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONTRIB Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.CONTRIB">
        <h5>Team Contribution Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Contribution Summary</h6>
                <div class="row text-center">
                  <div class="col-6 mb-2">
                    <div class="text-primary">
                      <strong>{{ contribAverage }}%</strong>
                      <br>
                      <small>Average</small>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="text-info">
                      <strong>{{ contribMedian }}%</strong>
                      <br>
                      <small>Median</small>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="text-success">
                      <strong>{{ contribStdDev }}%</strong>
                      <br>
                      <small>Std Dev</small>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-secondary">
                      <strong>{{ contribMin }}% - {{ contribMax }}%</strong>
                      <br>
                      <small>Range</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Contribution Distribution</h6>
                <div *ngFor="let contribution of contribDistribution | keyvalue: originalOrder" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ contribution.key }}%</span>
                    <span class="badge bg-danger">{{ contribution.value }} responses</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-danger"
                         [style.width.%]="(contribution.value / respondedCount) * 100"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="respondedCount === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RUBRIC Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.RUBRIC">
        <h5>Rubric Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Rubric Overview</h6>
                <div class="row text-center">
                  <div class="col-12 mb-2">
                    <div class="text-primary">
                      <strong>{{ rubricSubQuestions.length }}</strong>
                      <br>
                      <small>Criteria</small>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="text-info">
                      <strong>{{ rubricChoices.length }}</strong>
                      <br>
                      <small>Rating Levels</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Rating Distribution by Criteria</h6>
                <div *ngFor="let subQuestion of rubricSubQuestions" class="mb-4">
                  <h6 class="fw-bold text-dark">{{ subQuestion }}</h6>
                  <div *ngFor="let choice of rubricChoices" class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <span>{{ choice }}</span>
                      <span class="badge bg-light text-dark">{{ rubricChoiceFrequency[subQuestion][choice] }} ({{ rubricChoicePercentage[subQuestion][choice] }}%)</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                      <div class="progress-bar bg-light"
                           [style.width.%]="rubricChoicePercentage[subQuestion][choice]"
                           role="progressbar">
                      </div>
                    </div>
                  </div>
                </div>
                <div *ngIf="rubricSubQuestions.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RANK_OPTIONS Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.RANK_OPTIONS">
        <h5>Rank Options Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Ranking Overview</h6>
                <div class="row text-center">
                  <div class="col-12">
                    <div class="text-primary">
                      <strong>{{ rankOptions.length }}</strong>
                      <br>
                      <small>Options to Rank</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Average Ranking by Option</h6>
                <div *ngFor="let option of rankOptions" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">{{ option }}</span>
                    <span class="badge bg-primary">Avg Rank: {{ rankOptionAverageRank[option] || 'N/A' }}</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-primary"
                         [style.width.%]="rankOptionAverageRank[option] ? (1 / rankOptionAverageRank[option]) * 100 : 0"
                         role="progressbar">
                    </div>
                  </div>
                  <small class="text-muted">Lower average rank = better ranking</small>
                </div>
                <div *ngIf="rankOptions.length === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RANK_RECIPIENTS Question Visualization -->
      <div *ngIf="question.questionType === FeedbackQuestionType.RANK_RECIPIENTS">
        <h5>Rank Recipients Response Analytics</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Response Rate</h6>
                <div class="mb-2">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar"
                         [class.bg-success]="responseRate >= 80"
                         [class.bg-warning]="responseRate >= 50 && responseRate < 80"
                         [class.bg-danger]="responseRate < 50"
                         [style.width.%]="responseRate"
                         role="progressbar">
                      {{ responseRate.toFixed(1) }}%
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ respondedCount }} out of {{ responses.length }} respondents</small>
              </div>
            </div>
            <div class="card mt-3">
              <div class="card-body">
                <h6 class="card-title">Ranking Summary</h6>
                <div class="row text-center">
                  <div class="col-6 mb-2">
                    <div class="text-primary">
                      <strong>{{ rankRecipientAverage }}</strong>
                      <br>
                      <small>Average Rank</small>
                    </div>
                  </div>
                  <div class="col-6 mb-2">
                    <div class="text-info">
                      <strong>{{ rankRecipientMedian }}</strong>
                      <br>
                      <small>Median Rank</small>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-secondary">
                      <strong>{{ rankRecipientMin }} - {{ rankRecipientMax }}</strong>
                      <br>
                      <small>Range</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Rank Distribution</h6>
                <div *ngFor="let rank of rankRecipientDistribution | keyvalue: originalOrder" class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold">Rank {{ rank.key }}</span>
                    <span class="badge bg-warning text-dark">{{ rank.value }} responses</span>
                  </div>
                  <div class="progress" style="height: 15px;">
                    <div class="progress-bar bg-warning"
                         [style.width.%]="(rank.value / respondedCount) * 100"
                         role="progressbar">
                    </div>
                  </div>
                </div>
                <div *ngIf="respondedCount === 0" class="text-muted">
                  <em>No valid responses available for analysis</em>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fallback for other question types (now complete) -->
      <div *ngIf="question.questionType !== FeedbackQuestionType.TEXT && question.questionType !== FeedbackQuestionType.MCQ && question.questionType !== FeedbackQuestionType.MSQ && question.questionType !== FeedbackQuestionType.NUMSCALE && question.questionType !== FeedbackQuestionType.CONSTSUM && question.questionType !== FeedbackQuestionType.CONSTSUM_OPTIONS && question.questionType !== FeedbackQuestionType.CONSTSUM_RECIPIENTS && question.questionType !== FeedbackQuestionType.CONTRIB && question.questionType !== FeedbackQuestionType.RUBRIC && question.questionType !== FeedbackQuestionType.RANK_OPTIONS && question.questionType !== FeedbackQuestionType.RANK_RECIPIENTS">
        <h5>Response Statistics</h5>
        <p>Total Responses: {{ respondedCount }} / {{ responses.length }}</p>
        <p>Response Rate: {{ responseRate.toFixed(2) }}%</p>
        <p><em>This question type is not yet supported for detailed analytics.</em></p>
      </div>
    </div>
    <div *ngIf="!questionResult && !isLoading">
      <p>No responses submitted for this question yet.</p>
    </div>
  </div>
</tm-loading-retry>